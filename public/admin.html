<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç† - ç®¡ç†å‘˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-orange: #FF9500;
            --ios-red: #FF3B30;
            --ios-gray: #8E8E93;
            --ios-light-gray: #F2F2F7;
            --ios-divider: #C6C6C8;
            --ios-text-primary: #000000;
            --ios-text-secondary: #8E8E93;
            --ios-background: #FFFFFF;
            --ios-surface: #F9F9F9;
            --ios-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --ios-radius: 12px;
        }

        body {
            background-color: var(--ios-surface);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            color: var(--ios-text-primary);
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .admin-container {
            display: none;
        }

        .card {
            border: none;
            border-radius: var(--ios-radius);
            box-shadow: var(--ios-shadow);
            background: var(--ios-background);
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--ios-divider);
            font-weight: 600;
        }

        .file-card {
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            border-radius: var(--ios-radius);
            box-shadow: var(--ios-shadow);
            background: var(--ios-background);
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .stats-card {
            background: linear-gradient(135deg, var(--ios-blue) 0%, #5856D6 100%);
            color: white;
            border-radius: var(--ios-radius);
            box-shadow: var(--ios-shadow);
        }

        .trend-up { color: var(--ios-green); }
        .trend-down { color: var(--ios-red); }
        .trend-stable { color: var(--ios-gray); }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
        }

        .btn:hover {
            transform: scale(1.02);
        }

        .btn-primary {
            background: var(--ios-blue);
        }

        .btn-primary:hover {
            background: #0066CC;
        }

        .btn-success {
            background: var(--ios-green);
        }

        .btn-success:hover {
            background: #2DB854;
        }

        .btn-danger {
            background: var(--ios-red);
        }

        .btn-danger:hover {
            background: #E6352A;
        }

        .btn-warning {
            background: var(--ios-orange);
            color: white;
        }

        .btn-warning:hover {
            background: #E68A00;
        }

        .btn-outline-primary {
            border: 1.5px solid var(--ios-blue);
            color: var(--ios-blue);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--ios-blue);
            color: white;
        }

        .btn-outline-secondary {
            border: 1.5px solid var(--ios-gray);
            color: var(--ios-gray);
            background: transparent;
        }

        .btn-outline-secondary:hover {
            background: var(--ios-gray);
            color: white;
        }

        .btn-outline-info {
            border: 1.5px solid #5AC8FA;
            color: #5AC8FA;
            background: transparent;
        }

        .btn-outline-info:hover {
            background: #5AC8FA;
            color: white;
        }

        .navbar {
            background: var(--ios-background);
            box-shadow: 0 1px 0 var(--ios-divider);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .navbar-dark .navbar-nav .nav-link {
            color: var(--ios-text-primary);
            font-weight: 500;
        }

        .navbar-dark .navbar-nav .nav-link:hover {
            color: var(--ios-blue);
        }

        .modal-content {
            border-radius: var(--ios-radius);
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-bottom: 1px solid var(--ios-divider);
            font-weight: 600;
        }

        .modal-footer {
            border-top: 1px solid var(--ios-divider);
        }

        .form-control {
            border-radius: 10px;
            border: 1.5px solid var(--ios-divider);
            padding: 12px 16px;
            font-size: 16px;
        }

        .form-control:focus {
            border-color: var(--ios-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-select {
            border-radius: 10px;
            border: 1.5px solid var(--ios-divider);
            padding: 12px 16px;
        }

        .form-select:focus {
            border-color: var(--ios-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .breadcrumb {
            background: var(--ios-light-gray);
            border-radius: var(--ios-radius);
            padding: 12px 20px;
        }

        .breadcrumb-item a {
            color: var(--ios-blue);
            text-decoration: none;
        }

        .breadcrumb-item.active {
            color: var(--ios-text-primary);
            font-weight: 500;
        }

        h2, h5, h6 {
            font-weight: 600;
        }

        .card-title {
            font-weight: 600;
        }

        .card-text {
            color: var(--ios-text-secondary);
        }

        .table {
            background: var(--ios-background);
            border-radius: var(--ios-radius);
            overflow: hidden;
        }

        .table thead th {
            background: var(--ios-light-gray);
            font-weight: 600;
            border: none;
        }

        .table tbody tr {
            border-bottom: 1px solid var(--ios-divider);
        }

        .table tbody tr:hover {
            background: var(--ios-light-gray);
        }
    </style>
</head>
<body>
    <div id="loginSection" class="login-container">
        <div class="card shadow">
            <div class="card-header text-center py-4">
                <h5 class="card-title mb-0" style="font-size: 24px;">ç®¡ç†å‘˜ç™»å½•</h5>
            </div>
            <div class="card-body p-4">
                <div class="mb-4">
                    <label for="password" class="form-label" style="font-weight: 500;">å¯†ç </label>
                    <input type="password" class="form-control" id="password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                </div>
                <button onclick="login()" class="btn btn-primary w-100 py-3" style="font-size: 16px;">ç™»å½•</button>
                <div id="loginError" class="text-danger mt-3 text-center" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div id="adminSection" class="admin-container">
        <nav class="navbar navbar-expand-lg mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#" style="font-weight: 600; font-size: 20px;">æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showFiles()">æ–‡ä»¶åˆ—è¡¨</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showUpload()">ä¸Šä¼ æ–‡ä»¶</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showPublicFiles()">å…¬å…±æ–‡ä»¶</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showServerFiles()">æœåŠ¡å™¨æ–‡ä»¶</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showExtensionConfig()">åç¼€é…ç½®</a>
                        </li>
                    </ul>
                    <button onclick="logout()" class="btn btn-outline-primary btn-sm px-4">é€€å‡º</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <div id="filesSection" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 style="font-weight: 600;">æ–‡ä»¶åˆ—è¡¨</h2>
                    <button onclick="showUpload()" class="btn btn-primary">ä¸Šä¼ æ–‡ä»¶</button>
                </div>
                <div id="filesList" class="row g-3"></div>
            </div>

            <div id="uploadSection" class="section" style="display: none;">
                <h2 style="font-weight: 600; margin-bottom: 24px;">ä¸Šä¼ æ–‡ä»¶</h2>
                <div class="card">
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label for="fileInput" class="form-label" style="font-weight: 500;">é€‰æ‹©æ–‡ä»¶</label>
                            <input type="file" class="form-control" id="fileInput">
                        </div>
                        <div class="mb-4">
                            <label for="uploadPath" class="form-label" style="font-weight: 500;">ä¸Šä¼ è·¯å¾„ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰</label>
                            <input type="text" class="form-control" id="uploadPath" placeholder="/var/www/uploads æˆ– ./custom/path">
                        </div>
                        <button onclick="uploadFile()" class="btn btn-success px-5">ä¸Šä¼ </button>
                    </div>
                </div>
            </div>

            <div id="publicFilesSection" class="section" style="display: none;">
                <h2 style="font-weight: 600; margin-bottom: 24px;">å…¬å…±æ–‡ä»¶</h2>
                <div id="publicFilesList" class="row g-3"></div>
            </div>

            <div id="serverFilesSection" class="section" style="display: none;">
                <h2 style="font-weight: 600; margin-bottom: 24px;">æœåŠ¡å™¨æ–‡ä»¶ç®¡ç†</h2>
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="serverPathInput" placeholder="è¾“å…¥æœåŠ¡å™¨ç›®å½•è·¯å¾„ï¼ˆå¦‚ /www/wwwroot/file-manager/uploadsï¼‰" value="/www/wwwroot/file-manager/uploads">
                            <button onclick="browseServerPath()" class="btn btn-primary px-4">æµè§ˆ</button>
                        </div>
                    </div>
                </div>
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb" id="pathBreadcrumb"></ol>
                </nav>
                <div id="serverFilesList" class="row g-3"></div>
            </div>

            <div id="extensionConfigSection" class="section" style="display: none;">
                <h2 style="font-weight: 600; margin-bottom: 24px;">åç¼€é…ç½®ç®¡ç†</h2>
                
                <div class="card mb-4">
                    <div class="card-header" style="font-weight: 600;">é»˜è®¤é…ç½®</div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label" style="font-weight: 500;">å¤„ç†ç±»å‹</label>
                                <select class="form-select" id="defaultType">
                                    <option value="file">é»˜è®¤æ–‡ä»¶</option>
                                    <option value="redirect">è·³è½¬é“¾æ¥</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" style="font-weight: 500;">å¤„ç†å€¼</label>
                                <input type="text" class="form-control" id="defaultValue" placeholder="æ–‡ä»¶è·¯å¾„æˆ–URL">
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button onclick="updateDefaultConfig()" class="btn btn-primary w-100">æ›´æ–°</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center" style="font-weight: 600;">
                        <span>åç¼€é…ç½®åˆ—è¡¨</span>
                        <button onclick="showAddExtensionModal()" class="btn btn-success btn-sm">æ·»åŠ åç¼€</button>
                    </div>
                    <div class="card-body p-4">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>åç¼€</th>
                                        <th>ç±»å‹</th>
                                        <th>å¤„ç†å€¼</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="extensionList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="statisticsModal" class="modal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">è®¿é—®ç»Ÿè®¡</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="statisticsContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="editModal" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ç¼–è¾‘æ–‡ä»¶</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editFileId">
                            <div class="mb-3">
                                <label for="editOriginalName" class="form-label">æ–‡ä»¶å</label>
                                <input type="text" class="form-control" id="editOriginalName">
                            </div>
                            <div class="mb-3">
                                <label for="editIsPublic" class="form-label">å…¬å…±è®¿é—®</label>
                                <select class="form-select" id="editIsPublic">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editPublicPath" class="form-label">å…¬å…±è®¿é—®è·¯å¾„</label>
                                <input type="text" class="form-control" id="editPublicPath" placeholder="/public/my-file">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" onclick="saveFileEdit()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="registerModal" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">æ³¨å†ŒæœåŠ¡å™¨æ–‡ä»¶</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="registerFilePath">
                            <div class="mb-3">
                                <label for="registerFileName" class="form-label">æ–‡ä»¶å</label>
                                <input type="text" class="form-control" id="registerFileName" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="registerIsPublic" class="form-label">å…¬å…±è®¿é—®</label>
                                <select class="form-select" id="registerIsPublic">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="registerPublicPath" class="form-label">å…¬å…±è®¿é—®è·¯å¾„</label>
                                <input type="text" class="form-control" id="registerPublicPath" placeholder="/public/my-file">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" onclick="registerServerFile()">æ³¨å†Œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="batchSetAccessModal" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">æ‰¹é‡è®¾ç½®æ–‡ä»¶å¤¹è®¿é—®æ€§</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="batchFolderPath">
                            <div class="mb-3">
                                <label for="batchFolderName" class="form-label">æ–‡ä»¶å¤¹åç§°</label>
                                <input type="text" class="form-control" id="batchFolderName" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="batchIsPublic" class="form-label">å…¬å…±è®¿é—®</label>
                                <select class="form-select" id="batchIsPublic">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="batchPublicPathPrefix" class="form-label">å…¬å…±è®¿é—®è·¯å¾„å‰ç¼€</label>
                                <input type="text" class="form-control" id="batchPublicPathPrefix" placeholder="/public/my-folder">
                                <small class="text-muted">æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶å°†ä½¿ç”¨æ­¤è·¯å¾„å‰ç¼€ï¼Œä¾‹å¦‚ /public/my-folder/file.jpg</small>
                            </div>
                            <div class="mb-3">
                                <label for="batchRecursive" class="form-label">å¤„ç†å­æ–‡ä»¶å¤¹</label>
                                <select class="form-select" id="batchRecursive">
                                    <option value="true">æ˜¯ï¼ˆé€’å½’å¤„ç†æ‰€æœ‰å­æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼‰</option>
                                    <option value="false">å¦ï¼ˆä»…å¤„ç†å½“å‰æ–‡ä»¶å¤¹ï¼‰</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="batchOverwrite" class="form-label">è¦†ç›–å·²æ³¨å†Œæ–‡ä»¶</label>
                                <select class="form-select" id="batchOverwrite">
                                    <option value="false">å¦ï¼ˆè·³è¿‡å·²æ³¨å†Œçš„æ–‡ä»¶ï¼‰</option>
                                    <option value="true">æ˜¯ï¼ˆè¦†ç›–å·²æ³¨å†Œæ–‡ä»¶çš„è®¿é—®è®¾ç½®ï¼‰</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" onclick="batchSetAccess()">æ‰¹é‡è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="addExtensionModal" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">æ·»åŠ åç¼€é…ç½®</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="addExtension" class="form-label">æ–‡ä»¶åç¼€</label>
                                <input type="text" class="form-control" id="addExtension" placeholder="ä¾‹å¦‚ï¼šhtml, jpg, pdf">
                                <small class="text-muted">ä¸éœ€è¦è¾“å…¥ç‚¹å·ï¼Œä¾‹å¦‚è¾“å…¥ html</small>
                            </div>
                            <div class="mb-3">
                                <label for="addExtensionType" class="form-label">å¤„ç†ç±»å‹</label>
                                <select class="form-select" id="addExtensionType">
                                    <option value="file">é»˜è®¤æ–‡ä»¶</option>
                                    <option value="redirect">è·³è½¬é“¾æ¥</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="addExtensionValue" class="form-label">å¤„ç†å€¼</label>
                                <input type="text" class="form-control" id="addExtensionValue" placeholder="æ–‡ä»¶è·¯å¾„æˆ–URL">
                                <small class="text-muted">å¦‚æœæ˜¯æ–‡ä»¶ï¼Œè¾“å…¥ç›¸å¯¹è·¯å¾„ï¼›å¦‚æœæ˜¯è·³è½¬ï¼Œè¾“å…¥å®Œæ•´URL</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" onclick="addExtension()">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let authToken = localStorage.getItem('authToken');
        let editModal, statisticsModal;

        document.addEventListener('DOMContentLoaded', function() {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            statisticsModal = new bootstrap.Modal(document.getElementById('statisticsModal'));
            registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            batchSetAccessModal = new bootstrap.Modal(document.getElementById('batchSetAccessModal'));
            addExtensionModal = new bootstrap.Modal(document.getElementById('addExtensionModal'));
            checkAuth();
        });

        async function checkAuth() {
            try {
                const response = await fetch('/api/admin/check', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (data.authenticated) {
                    showAdmin();
                } else {
                    showLogin();
                }
            } catch (error) {
                showLogin();
            }
        }

        async function login() {
            const password = document.getElementById('password').value;
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await response.json();
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showAdmin();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function logout() {
            await fetch('/api/admin/logout', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            authToken = null;
            localStorage.removeItem('authToken');
            showLogin();
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminSection').style.display = 'none';
        }

        function showAdmin() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            showFiles();
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showFiles() {
            hideAllSections();
            document.getElementById('filesSection').style.display = 'block';
            loadFiles();
        }

        function showUpload() {
            hideAllSections();
            document.getElementById('uploadSection').style.display = 'block';
        }

        function showPublicFiles() {
            hideAllSections();
            document.getElementById('publicFilesSection').style.display = 'block';
            loadPublicFiles();
        }

        function showServerFiles() {
            hideAllSections();
            document.getElementById('serverFilesSection').style.display = 'block';
            browseServerPath();
        }

        function showExtensionConfig() {
            hideAllSections();
            document.getElementById('extensionConfigSection').style.display = 'block';
            loadExtensionConfig();
        }

        function hideAllSections() {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        }

        async function loadFiles() {
            try {
                const response = await fetch('/api/admin/files', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                renderFiles(data.files, 'filesList');
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        async function loadPublicFiles() {
            try {
                const response = await fetch('/api/admin/public-files', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                renderFiles(data.files, 'publicFilesList', true);
            } catch (error) {
                console.error('åŠ è½½å…¬å…±æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        function renderFiles(files, containerId, isPublic = false) {
            const container = document.getElementById(containerId);
            if (files.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5">æš‚æ— æ–‡ä»¶</div>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="col-md-6 col-lg-4">
                    <div class="card file-card h-100">
                        <div class="card-body">
                            <h6 class="card-title text-truncate mb-3" title="${file.originalName}">${file.originalName}</h6>
                            <p class="card-text small mb-2" style="color: var(--ios-text-secondary);">
                                å¤§å°: ${formatFileSize(file.size)}
                            </p>
                            <p class="card-text small mb-2" style="color: var(--ios-text-secondary);">
                                ä¸Šä¼ æ—¶é—´: ${formatDate(file.uploadTime)}
                            </p>
                            ${file.isPublic ? `<p class="card-text small mb-2" style="color: var(--ios-green);">å…¬å…±è·¯å¾„: ${file.publicPath || 'æœªè®¾ç½®'}</p>` : ''}
                            ${file.accessCount ? `<p class="card-text small mb-0" style="color: var(--ios-blue);">è®¿é—®æ¬¡æ•°: ${file.accessCount}</p>` : ''}
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100" role="group">
                                <button onclick="downloadFile('${file.id}')" class="btn btn-sm btn-outline-primary">ä¸‹è½½</button>
                                <button onclick="editFile('${file.id}')" class="btn btn-sm btn-outline-secondary">ç¼–è¾‘</button>
                                ${file.isPublic ? `
                                    <button onclick="showStatistics('${file.id}')" class="btn btn-sm btn-outline-info">ç»Ÿè®¡</button>
                                    <button onclick="copyPublicPath('${file.id}')" class="btn btn-sm btn-outline-info">å¤åˆ¶é“¾æ¥</button>
                                ` : ''}
                                <button onclick="deleteFile('${file.id}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const uploadPath = document.getElementById('uploadPath').value;
            
            if (!fileInput.files.length) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (uploadPath) {
                formData.append('uploadPath', uploadPath);
            }

            try {
                const response = await fetch('/api/admin/upload-to-path', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                    fileInput.value = '';
                    document.getElementById('uploadPath').value = '';
                    showFiles();
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        async function downloadFile(id) {
            try {
                const response = await fetch(`/api/admin/files/${id}/download`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'download';
                    a.click();
                    window.URL.revokeObjectURL(url);
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥');
            }
        }

        async function editFile(id) {
            try {
                const response = await fetch(`/api/admin/files/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                const file = data.file;
                
                document.getElementById('editFileId').value = file.id;
                document.getElementById('editOriginalName').value = file.originalName;
                document.getElementById('editIsPublic').value = file.isPublic ? 'true' : 'false';
                document.getElementById('editPublicPath').value = file.publicPath || '';
                
                editModal.show();
            } catch (error) {
                alert('åŠ è½½æ–‡ä»¶ä¿¡æ¯å¤±è´¥');
            }
        }

        async function saveFileEdit() {
            const id = document.getElementById('editFileId').value;
            const originalName = document.getElementById('editOriginalName').value;
            const isPublic = document.getElementById('editIsPublic').value === 'true';
            const publicPath = document.getElementById('editPublicPath').value;

            try {
                const response = await fetch(`/api/admin/files/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ originalName, isPublic, publicPath })
                });
                const data = await response.json();
                if (response.ok) {
                    editModal.hide();
                    loadFiles();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function deleteFile(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/files/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    loadFiles();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function showStatistics(id) {
            try {
                const response = await fetch(`/api/admin/files/${id}/statistics`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                const stats = data.statistics;
                
                const trendClass = stats.trend === 'increasing' ? 'trend-up' : 
                                   stats.trend === 'decreasing' ? 'trend-down' : 'trend-stable';
                const trendText = stats.trend === 'increasing' ? 'ä¸Šå‡' : 
                                  stats.trend === 'decreasing' ? 'ä¸‹é™' : 'ç¨³å®š';

                document.getElementById('statisticsContent').innerHTML = `
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0">${stats.totalAccess}</h3>
                                    <small>æ€»è®¿é—®æ¬¡æ•°</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0">${stats.uniqueDays}</h3>
                                    <small>æ´»è·ƒå¤©æ•°</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0">${stats.averagePerDay}</h3>
                                    <small>æ—¥å‡è®¿é—®</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0 ${trendClass}">${trendText}</h3>
                                    <small>è®¿é—®è¶‹åŠ¿</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h6>æ¯æ—¥è®¿é—®ç»Ÿè®¡</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>è®¿é—®æ¬¡æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(stats.dailyStats).map(([date, count]) => `
                                    <tr>
                                        <td>${date}</td>
                                        <td>${count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                statisticsModal.show();
            } catch (error) {
                alert('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN');
        }

        async function browseServerPath() {
            const path = document.getElementById('serverPathInput').value;
            if (!path) {
                alert('è¯·è¾“å…¥è·¯å¾„');
                return;
            }
            try {
                const response = await fetch(`/api/admin/server/browse?path=${encodeURIComponent(path)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    renderServerFilesWithDirs(data.directories, data.files, data.currentPath);
                } else {
                    alert('æµè§ˆå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æµè§ˆå¤±è´¥: ' + error.message);
            }
        }

        function renderServerFiles(files, currentPath) {
            const container = document.getElementById('serverFilesList');
            if (!files || files.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted">è¯¥ç›®å½•ä¸‹æ²¡æœ‰æ–‡ä»¶</div>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="col-md-6 col-lg-4">
                    <div class="card file-card h-100">
                        <div class="card-body">
                            <h6 class="card-title text-truncate" title="${file.name}">${file.name}</h6>
                            <p class="card-text small text-muted mb-1">
                                å¤§å°: ${formatFileSize(file.size)}
                            </p>
                            <p class="card-text small text-muted mb-1">
                                è·¯å¾„: ${file.path}
                            </p>
                            <p class="card-text small text-info mb-1">
                                çŠ¶æ€: ${file.registered ? 'å·²æ³¨å†Œ' : 'æœªæ³¨å†Œ'}
                            </p>
                        </div>
                        <div class="card-footer">
                            ${file.registered ? `
                                <div class="btn-group w-100" role="group">
                                    <button onclick="editFile('${file.fileId}')" class="btn btn-sm btn-outline-primary">ç®¡ç†</button>
                                    <button onclick="downloadFile('${file.fileId}')" class="btn btn-sm btn-outline-secondary">ä¸‹è½½</button>
                                </div>
                            ` : `
                                <button onclick="showRegisterModal('${file.path}', '${file.name}')" class="btn btn-sm btn-success w-100">æ³¨å†Œå¹¶è®¾ç½®å…¬å¼€è®¿é—®</button>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderServerFilesWithDirs(directories, files, currentPath) {
            const container = document.getElementById('serverFilesList');
            updateBreadcrumb(currentPath);

            if ((!directories || directories.length === 0) && (!files || files.length === 0)) {
                container.innerHTML = '<div class="col-12 text-center text-muted">è¯¥ç›®å½•ä¸‹æ²¡æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹</div>';
                return;
            }

            let html = '';

            if (directories && directories.length > 0) {
                directories.forEach(dir => {
                    html += `
                        <div class="col-md-6 col-lg-4">
                            <div class="card file-card h-100" style="border-left: 4px solid var(--ios-orange);">
                                <div class="card-body">
                                    <h6 class="card-title text-truncate mb-3" title="${dir.name}">ğŸ“ ${dir.name}</h6>
                                    <p class="card-text small mb-0" style="color: var(--ios-text-secondary);">
                                        ${dir.path}
                                    </p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="btn-group w-100" role="group">
                                        <button onclick="navigateToDirectory('${dir.path}')" class="btn btn-sm btn-warning">è¿›å…¥</button>
                                        <button onclick="showBatchSetAccessModal('${dir.path}', '${dir.name}')" class="btn btn-sm btn-success">æ‰¹é‡è®¾ç½®</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            if (files && files.length > 0) {
                files.forEach(file => {
                    html += `
                        <div class="col-md-6 col-lg-4">
                            <div class="card file-card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-truncate mb-3" title="${file.name}">ğŸ“„ ${file.name}</h6>
                                    <p class="card-text small mb-2" style="color: var(--ios-text-secondary);">
                                        å¤§å°: ${formatFileSize(file.size)}
                                    </p>
                                    <p class="card-text small mb-2" style="color: var(--ios-text-secondary);">
                                        ${file.path}
                                    </p>
                                    <p class="card-text small mb-0" style="color: ${file.registered ? 'var(--ios-green)' : 'var(--ios-gray)'};">
                                        ${file.registered ? 'âœ“ å·²æ³¨å†Œ' : 'â—‹ æœªæ³¨å†Œ'}
                                    </p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    ${file.registered ? `
                                        <div class="btn-group w-100" role="group">
                                            <button onclick="editFile('${file.fileId}')" class="btn btn-sm btn-outline-primary">ç®¡ç†</button>
                                            <button onclick="downloadFile('${file.fileId}')" class="btn btn-sm btn-outline-secondary">ä¸‹è½½</button>
                                            <button onclick="copyPublicPath('${file.fileId}')" class="btn btn-sm btn-outline-info">å¤åˆ¶é“¾æ¥</button>
                                        </div>
                                    ` : `
                                        <button onclick="showRegisterModal('${file.path}', '${file.name}')" class="btn btn-sm btn-success w-100">æ³¨å†Œæ–‡ä»¶</button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function navigateToDirectory(path) {
            document.getElementById('serverPathInput').value = path;
            browseServerPath();
        }

        function updateBreadcrumb(currentPath) {
            const breadcrumb = document.getElementById('pathBreadcrumb');
            if (!currentPath) {
                breadcrumb.innerHTML = '';
                return;
            }

            const parts = currentPath.split('/').filter(p => p);
            let html = '<li class="breadcrumb-item"><a href="#" onclick="navigateToDirectory(\'/\')">æ ¹ç›®å½•</a></li>';
            
            let buildPath = '';
            parts.forEach((part, index) => {
                buildPath += '/' + part;
                if (index === parts.length - 1) {
                    html += `<li class="breadcrumb-item active" aria-current="page">${part}</li>`;
                } else {
                    html += `<li class="breadcrumb-item"><a href="#" onclick="navigateToDirectory('${buildPath}')">${part}</a></li>`;
                }
            });

            breadcrumb.innerHTML = html;
        }

        function showRegisterModal(filePath, fileName) {
            document.getElementById('registerFilePath').value = filePath;
            document.getElementById('registerFileName').value = fileName;
            registerModal.show();
        }

        async function registerServerFile() {
            const filePath = document.getElementById('registerFilePath').value;
            const fileName = document.getElementById('registerFileName').value;
            const isPublic = document.getElementById('registerIsPublic').value === 'true';
            const publicPath = document.getElementById('registerPublicPath').value;

            try {
                const response = await fetch('/api/admin/server/register', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filePath, fileName, isPublic, publicPath })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('æ–‡ä»¶æ³¨å†ŒæˆåŠŸ');
                    registerModal.hide();
                    browseServerPath();
                } else {
                    alert('æ³¨å†Œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            }
        }

        function showBatchSetAccessModal(folderPath, folderName) {
            document.getElementById('batchFolderPath').value = folderPath;
            document.getElementById('batchFolderName').value = folderName;
            batchSetAccessModal.show();
        }

        async function batchSetAccess() {
            const folderPath = document.getElementById('batchFolderPath').value;
            const isPublic = document.getElementById('batchIsPublic').value === 'true';
            const publicPathPrefix = document.getElementById('batchPublicPathPrefix').value;
            const recursive = document.getElementById('batchRecursive').value === 'true';
            const overwrite = document.getElementById('batchOverwrite').value === 'true';

            if (!publicPathPrefix) {
                alert('è¯·è¾“å…¥å…¬å…±è®¿é—®è·¯å¾„å‰ç¼€');
                return;
            }

            try {
                const response = await fetch('/api/admin/server/batch-set-access', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folderPath, isPublic, publicPathPrefix, recursive, overwrite })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(`æ‰¹é‡è®¾ç½®æˆåŠŸï¼å…±å¤„ç† ${data.total} ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸ ${data.success} ä¸ªï¼Œå¤±è´¥ ${data.failed} ä¸ª`);
                    batchSetAccessModal.hide();
                    browseServerPath();
                } else {
                    alert('æ‰¹é‡è®¾ç½®å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æ‰¹é‡è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        async function copyPublicPath(fileId) {
            try {
                const response = await fetch(`/api/admin/files/${fileId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                const file = data.file;
                
                if (file.isPublic && file.publicPath) {
                    const protocol = window.location.protocol;
                    const host = window.location.host;
                    // åœ¨å…¬å…±è·¯å¾„ååŠ ä¸Šæ–‡ä»¶å
                    const publicUrl = `${protocol}//${host}/public${file.publicPath}/${file.fileName}`;
                    
                    await navigator.clipboard.writeText(publicUrl);
                    alert('è®¿é—®é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š\n' + publicUrl);
                } else {
                    alert('è¯¥æ–‡ä»¶æœªè®¾ç½®å…¬å¼€è®¿é—®');
                }
            } catch (error) {
                alert('å¤åˆ¶å¤±è´¥: ' + error.message);
            }
        }

        async function loadExtensionConfig() {
            try {
                const response = await fetch('/api/admin/extensions', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                renderExtensionConfig(data.config);
            } catch (error) {
                alert('åŠ è½½åç¼€é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        function renderExtensionConfig(config) {
            // å¡«å……é»˜è®¤é…ç½®
            document.getElementById('defaultType').value = config.default.type;
            document.getElementById('defaultValue').value = config.default.value;

            // æ¸²æŸ“åç¼€åˆ—è¡¨
            const tbody = document.getElementById('extensionList');
            if (Object.keys(config.extensions).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— åç¼€é…ç½®</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(config.extensions).map(([ext, cfg]) => `
                <tr>
                    <td><code>.${ext}</code></td>
                    <td>${cfg.type === 'file' ? 'é»˜è®¤æ–‡ä»¶' : 'è·³è½¬é“¾æ¥'}</td>
                    <td class="text-truncate" style="max-width: 300px;" title="${cfg.value}">${cfg.value}</td>
                    <td>
                        <button onclick="deleteExtension('${ext}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateDefaultConfig() {
            const type = document.getElementById('defaultType').value;
            const value = document.getElementById('defaultValue').value;

            if (!value) {
                alert('è¯·è¾“å…¥å¤„ç†å€¼');
                return;
            }

            try {
                const response = await fetch('/api/admin/extensions/default', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, value })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('é»˜è®¤é…ç½®æ›´æ–°æˆåŠŸ');
                    loadExtensionConfig();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        function showAddExtensionModal() {
            document.getElementById('addExtension').value = '';
            document.getElementById('addExtensionType').value = 'file';
            document.getElementById('addExtensionValue').value = '';
            addExtensionModal.show();
        }

        async function addExtension() {
            const extension = document.getElementById('addExtension').value.replace(/^\./, '');
            const type = document.getElementById('addExtensionType').value;
            const value = document.getElementById('addExtensionValue').value;

            if (!extension || !value) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            try {
                const response = await fetch('/api/admin/extensions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ extension, type, value })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('åç¼€é…ç½®æ·»åŠ æˆåŠŸ');
                    addExtensionModal.hide();
                    loadExtensionConfig();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }

        async function deleteExtension(extension) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åç¼€ .${extension} çš„é…ç½®å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/extensions/${extension}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    loadExtensionConfig();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>